---
import BaseLayout from "../layouts/BaseLayout.astro";
import Footer from "../components/Footer.astro";
import { getReadingList } from "../utils/books";

// Fetch reading list at build time
const books = (await getReadingList()).sort((a, b) => b.rating - a.rating);

// Minimalist Architect styling
const title = "Reading List | Oliver Thylmann";
---

<BaseLayout title={title}>
    <div class="layout-grid pt-20 pb-20">
        <div class="full-width md:col-start-2 md:col-end-3 px-6">
            <header class="mb-12">
                <a
                    href="/"
                    class="text-accent font-mono text-sm hover:underline mb-4 inline-block"
                    >← Back Home</a
                >
                <h1
                    class="font-space font-bold text-5xl md:text-7xl text-text-main tracking-tighter mb-4"
                >
                    Reading <span class="text-text-muted">List</span>
                </h1>
                <p class="text-text-secondary font-mono text-lg max-w-2xl">
                    A curated selection of books I've read, tracked via
                    Goodreads. These are the ideas that shape my strategy and
                    philosophy.
                </p>
            </header>

            {
                books.length > 0 ? (
                    <div
                        id="books-grid"
                        class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 2xl:grid-cols-12 gap-3"
                    >
                        {books.map((book) => (
                            <div class="book-card group flex flex-col h-full glass-card border border-white/5 rounded overflow-hidden transition-all hover:border-accent/40 relative">
                                <a
                                    href={book.link}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="aspect-[2/3] w-full bg-zinc-900 border-b border-white/5 overflow-hidden block"
                                >
                                    <img
                                        src={book.coverImage}
                                        alt={book.title}
                                        class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                                        loading="lazy"
                                    />
                                </a>
                                <div class="p-1.5 flex-grow flex flex-col">
                                    <div class="mb-1">
                                        <h3 class="font-space font-bold text-[9px] leading-tight text-text-main line-clamp-1 mb-0">
                                            {book.title}
                                        </h3>
                                        <p class="text-text-muted text-[8px] font-medium line-clamp-1 opacity-70">
                                            {book.author}
                                        </p>
                                    </div>

                                    <div class="mt-auto flex justify-between items-center pt-1 border-t border-white/5">
                                        <div class="flex items-center gap-0 text-accent font-mono text-[8px]">
                                            {Array.from({ length: 5 }).map(
                                                (_, i) => (
                                                    <span
                                                        class={
                                                            i < book.rating
                                                                ? "text-accent"
                                                                : "text-white/5"
                                                        }
                                                    >
                                                        ★
                                                    </span>
                                                ),
                                            )}
                                        </div>
                                        <span class="text-[7px] font-mono text-text-muted uppercase tracking-tighter shrink-0 opacity-50">
                                            {book.readDate
                                                ? new Date(
                                                      book.readDate,
                                                  ).getFullYear()
                                                : ""}
                                        </span>
                                    </div>
                                    {book.review && (
                                        <div class="mt-2 pt-2 border-t border-white/5 flex justify-end">
                                            <button
                                                class="notes-trigger text-[7px] font-mono text-accent/70 hover:text-accent transition-colors flex items-center gap-1 cursor-pointer"
                                                aria-label="View personal notes"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="w-2 h-2"
                                                    viewBox="0 0 24 24"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    stroke-width="2"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                >
                                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                                                </svg>
                                                NOTES
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {book.review && (
                                    <div class="notes-overlay absolute inset-0 bg-black/95 backdrop-blur-md p-3 opacity-0 pointer-events-none transition-all duration-300 flex flex-col z-20">
                                        <div class="flex justify-between items-center mb-2">
                                            <h4 class="text-accent font-mono text-[8px] uppercase tracking-widest">
                                                Personal Notes
                                            </h4>
                                            <button class="close-notes text-text-muted hover:text-text-main transition-colors cursor-pointer">
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="w-3 h-3"
                                                    viewBox="0 0 24 24"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    stroke-width="2"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                >
                                                    <line
                                                        x1="18"
                                                        y1="6"
                                                        x2="6"
                                                        y2="18"
                                                    />
                                                    <line
                                                        x1="6"
                                                        y1="6"
                                                        x2="18"
                                                        y2="18"
                                                    />
                                                </svg>
                                            </button>
                                        </div>
                                        <div
                                            class="text-text-secondary font-mono text-[8px] leading-relaxed overflow-y-auto pr-1 custom-scrollbar"
                                            set:html={book.review}
                                        />
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                ) : (
                    <div class="py-20 text-center border border-dashed border-white/10 rounded-lg">
                        <p class="text-text-muted font-mono">
                            No books found in the collection.
                        </p>
                        <p class="text-text-secondary text-sm mt-2">
                            The library is currently empty. Check back soon.
                        </p>
                    </div>
                )
            }

            <!-- Technical Meta Info -->
            <div
                class="mt-20 pt-8 border-t border-white/5 flex flex-col md:flex-row justify-between gap-4"
            >
                <div class="text-xs font-mono text-text-muted">
                    Source: goodreads.com
                </div>
                <div class="text-xs font-mono text-text-muted">
                    Last Synced: {new Date().toISOString().split("T")[0]}
                </div>
            </div>
        </div>
    </div>
    <Footer />
</BaseLayout>

<script>
    // Handle notes overlay
    document.querySelectorAll(".book-card").forEach((card) => {
        const trigger = card.querySelector(".notes-trigger");
        const overlay = card.querySelector(".notes-overlay");
        const close = card.querySelector(".close-notes");

        if (trigger && overlay && close) {
            trigger.addEventListener("click", (e) => {
                e.preventDefault();
                overlay.classList.add("active");
            });
            close.addEventListener("click", (e) => {
                e.preventDefault();
                overlay.classList.remove("active");
            });

            // Close on escape key
            document.addEventListener("keydown", (e) => {
                if (
                    e.key === "Escape" &&
                    overlay.classList.contains("active")
                ) {
                    overlay.classList.remove("active");
                }
            });
        }
    });
</script>

<style>
    .book-card {
        backdrop-filter: blur(8px);
    }
    .notes-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }
    .custom-scrollbar::-webkit-scrollbar {
        width: 2px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(var(--accent-rgb), 0.3);
        border-radius: 10px;
    }
</style>
