---
import BaseLayout from "../layouts/BaseLayout.astro";
import VinylCard from "../components/VinylCard.astro";
import Footer from "../components/Footer.astro";
import { getVinylCollection } from "../utils/discogs";

// Use environment variable or default
const DISCOGS_USERNAME = import.meta.env.DISCOGS_USERNAME || "othylmann";

// Fetch collection at build time
const collection = await getVinylCollection(DISCOGS_USERNAME);

// Extract unique genres
const allGenres = [
    ...new Set(collection.flatMap((item) => item.genres)),
].sort();

// Minimalist Architect styling
const title = "Vinyl Collection | Oliver Thylmann";
---

<BaseLayout title={title}>
    <div class="layout-grid pt-20 pb-20">
        <div class="full-width md:col-start-2 md:col-end-3 px-6">
            <header class="mb-12">
                <a
                    href="/"
                    class="text-amber-400 font-mono text-sm hover:underline mb-4 inline-block"
                    >‚Üê Back Home</a
                >
                <h1
                    class="font-space font-bold text-5xl md:text-7xl text-white tracking-tighter mb-4"
                >
                    Vinyl <span class="text-zinc-500">Collection</span>
                </h1>
                <p class="text-zinc-400 font-mono text-lg max-w-2xl">
                    A curated selection of my physical records, managed via
                    Discogs and synched daily. I started this in 2026, so bear
                    with me please while I get into the groove.
                </p>
            </header>

            <!-- Genre Filter -->
            <nav
                class="mb-12 border-b border-white/10 pb-6 overflow-x-auto no-scrollbar"
            >
                <div class="flex gap-4 min-w-max pb-2">
                    <button
                        data-genre="all"
                        class="filter-btn active text-sm font-mono px-4 py-2 rounded-full border border-white/10 hover:border-amber-400/50 transition-all cursor-pointer"
                    >
                        All
                    </button>
                    {
                        allGenres.map((genre) => (
                            <button
                                data-genre={genre}
                                class="filter-btn text-sm font-mono px-4 py-2 rounded-full border border-white/10 hover:border-amber-400/50 transition-all cursor-pointer"
                            >
                                {genre}
                            </button>
                        ))
                    }
                </div>
            </nav>

            {
                collection.length > 0 ? (
                    <div
                        id="vinyl-grid"
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
                    >
                        {collection.map((item) => (
                            <div
                                class="vinyl-item-wrapper"
                                data-genres={item.genres.join(",")}
                            >
                                <VinylCard item={item} />
                            </div>
                        ))}
                    </div>
                ) : (
                    <div class="py-20 text-center border border-dashed border-white/10 rounded-lg">
                        <p class="text-zinc-500 font-mono">
                            No records found in collection '{DISCOGS_USERNAME}'.
                        </p>
                        <p class="text-zinc-600 text-sm mt-2">
                            Check your credentials and public visibility on
                            Discogs.
                        </p>
                    </div>
                )
            }

            <!-- Technical Meta Info -->
            <div
                class="mt-20 pt-8 border-t border-white/5 flex flex-col md:flex-row justify-between gap-4"
            >
                <div class="text-xs font-mono text-zinc-600">
                    Source: api.discogs.com
                </div>
                <div class="text-xs font-mono text-zinc-600">
                    Build Time: {new Date().toISOString()}
                </div>
            </div>
        </div>
    </div>
    <Footer />
</BaseLayout>

<script>
    function updateFilters() {
        const urlParams = new URLSearchParams(window.location.search);
        const activeGenre = urlParams.get("genre") || "all";

        // Update button states
        const buttons = document.querySelectorAll(".filter-btn");
        buttons.forEach((btn) => {
            if (btn instanceof HTMLElement) {
                if (btn.dataset.genre === activeGenre) {
                    btn.classList.add(
                        "bg-amber-400",
                        "text-black",
                        "border-amber-400",
                    );
                    btn.classList.remove("text-zinc-400", "border-white/10");
                } else {
                    btn.classList.remove(
                        "bg-amber-400",
                        "text-black",
                        "border-amber-400",
                    );
                    btn.classList.add("text-zinc-400", "border-white/10");
                }
            }
        });

        // Update items
        const items = document.querySelectorAll(".vinyl-item-wrapper");
        items.forEach((item) => {
            if (item instanceof HTMLElement) {
                const genres = item.dataset.genres?.split(",") || [];
                if (activeGenre === "all" || genres.includes(activeGenre)) {
                    item.style.display = "block";
                } else {
                    item.style.display = "none";
                }
            }
        });
    }

    // Handle button clicks
    document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
            if (btn instanceof HTMLElement) {
                const genre = btn.dataset.genre;
                const url = new URL(window.location.href);
                if (genre === "all") {
                    url.searchParams.delete("genre");
                } else {
                    url.searchParams.set("genre", genre || "");
                }
                window.history.pushState({}, "", url);
                updateFilters();
            }
        });
    });

    // Listen for back/forward
    window.addEventListener("popstate", updateFilters);

    // Initial check
    updateFilters();
</script>

<style>
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .filter-btn {
        white-space: nowrap;
    }
</style>
