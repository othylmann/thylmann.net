---
const { item } = Astro.props;
import type { VinylItem } from "../utils/discogs";

interface Props {
    item: VinylItem;
}

const {
    artists,
    title,
    coverImage,
    year,
    genres,
    styles,
    notes,
    communityRating,
    personalRating,
    albumUrl,
} = item;
---

<div
    class="vinyl-card group relative flex flex-col h-full bg-white/5 border border-white/10 rounded-lg overflow-hidden transition-all hover:border-amber-400/50 hover:bg-white/10"
>
    <!-- Aspect ratio container for the cover -->
    <a
        href={albumUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="aspect-square w-full overflow-hidden bg-zinc-900 border-b border-white/10 block"
    >
        <img
            src={coverImage}
            alt={`${artists.map((a: any) => a.name).join(", ")} - ${title}`}
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
            loading="lazy"
        />
    </a>

    <div class="p-4 flex-grow flex flex-col min-h-[180px]">
        <div class="flex justify-between items-start gap-2 mb-2">
            <h3
                class="font-space font-bold text-lg leading-tight text-white group-hover:text-amber-400 transition-colors line-clamp-2"
            >
                <a href={albumUrl} target="_blank" rel="noopener noreferrer">
                    {title}
                </a>
            </h3>
            <div
                class="flex items-center gap-1 text-amber-400 font-mono text-sm shrink-0 cursor-help"
                title={`My Rating: ${personalRating || "N/A"} / Avg. User Rating: ${communityRating.toFixed(1)}`}
            >
                <span>â˜…</span>
                <span>
                    {personalRating || "-"}<span class="text-zinc-500 mx-0.5"
                        >/</span
                    >{communityRating.toFixed(1)}
                </span>
            </div>
        </div>

        <p class="text-zinc-400 font-medium text-sm mb-3 line-clamp-1">
            {
                artists.map((artist: any, index: number) => (
                    <>
                        <a
                            href={artist.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="hover:text-white transition-colors"
                        >
                            {artist.name}
                        </a>
                        {index < artists.length - 1 && ", "}
                    </>
                ))
            }
        </p>

        <!-- Genres -->
        <div class="flex flex-wrap gap-2 mb-4">
            {
                genres.map((genre: string) => (
                    <button
                        class="genre-tag text-[10px] font-mono px-2 py-0.5 bg-zinc-800 text-zinc-400 rounded hover:bg-amber-400 hover:text-black transition-colors cursor-pointer"
                        data-genre={genre}
                    >
                        {genre}
                    </button>
                ))
            }
        </div>

        <div
            class="flex items-center justify-between mt-auto pt-2 border-t border-white/5"
        >
            <span class="text-xs font-mono text-zinc-500 uppercase">
                {year > 0 ? `${year}` : "N/A"}
            </span>

            {
                notes && notes.trim().length > 0 && (
                    <button
                        class="notes-trigger text-xs font-mono text-amber-400/70 hover:text-amber-400 transition-colors flex items-center gap-1 cursor-pointer"
                        aria-label="View personal notes"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-3 h-3"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                        </svg>
                        Notes
                    </button>
                )
            }
        </div>
    </div>

    <!-- Notes Overlay -->
    {
        notes && notes.trim().length > 0 && (
            <div class="notes-overlay absolute inset-0 bg-black/90 backdrop-blur-md p-6 opacity-0 pointer-events-none transition-opacity flex flex-col z-10">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-amber-400 font-mono text-sm uppercase tracking-widest">
                        Personal Notes
                    </h4>
                    <button class="close-notes text-zinc-500 hover:text-white transition-colors cursor-pointer">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <>
                                <line x1="18" y1="6" x2="6" y2="18" />
                                <line x1="6" y1="6" x2="18" y2="18" />
                            </>
                        </svg>
                    </button>
                </div>
                <div class="text-zinc-300 font-mono text-sm leading-relaxed overflow-y-auto">
                    {notes}
                </div>
            </div>
        )
    }

    <!-- Decorative technical element -->
    <div
        class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity"
    >
        <div class="w-1 h-1 bg-amber-400 rounded-full animate-pulse"></div>
    </div>
</div>

<script>
    // Handle notes overlay
    document.querySelectorAll(".vinyl-card").forEach((card) => {
        const trigger = card.querySelector(".notes-trigger");
        const overlay = card.querySelector(".notes-overlay");
        const close = card.querySelector(".close-notes");

        if (trigger && overlay && close) {
            trigger.addEventListener("click", (e) => {
                e.preventDefault();
                overlay.classList.add("active");
            });
            close.addEventListener("click", (e) => {
                e.preventDefault();
                overlay.classList.remove("active");
            });
        }
    });

    // Handle genre tag clicks (they should trigger the filter on the parent page)
    document.querySelectorAll(".genre-tag").forEach((tag) => {
        tag.addEventListener("click", (e) => {
            e.preventDefault();
            const genre = (tag as HTMLElement).dataset.genre;
            if (genre) {
                const url = new URL(window.location.href);
                url.searchParams.set("genre", genre);
                window.history.pushState({}, "", url);

                // Dispatch a custom event that the parent page can listen to
                // or just trigger the updateFilters if it's in the same scope.
                // Since this script runs on all cards, and the parent script runs too,
                // we can just trigger a popstate or call the function if it was global.
                // The easiest way is to just call a global function or trigger an event.
                window.dispatchEvent(new Event("popstate"));
            }
        });
    });
</script>

<style>
    .vinyl-card {
        backdrop-filter: blur(8px);
    }
    .notes-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }
</style>
